---

- name: Determine pip version to install and use
  set_fact:
    pip_version_to_use: >-
      {%- if pip_version -%}
        {%- if pip_version|int == 3 -%}
          3
        {%- elif pip_version|int == 2 -%}
          2
        {%- endif -%}
      {%- elif ansible_python.version.major|int == 3 -%}
        3
      {%- elif ansible_python.version.major|int == 2 -%}
        2
      {%- endif -%}

- name: Set pip version to {{ pip_version_to_use }}
  set_fact:
    pip_apt_package: >-
      {%- if pip_version_to_use|int == 3 -%}
        python3-pip
      {%- elif pip_version_to_use|int == 2 -%}
        python-pip
      {%- endif -%}
    pip_executable: >-
      {%- if pip_version_to_use|int == 3 -%}
        pip3
      {%- elif pip_version_to_use|int == 2 -%}
        pip2
      {%- endif -%}

- name: Install pip{{ pip_version_to_use }}
  apt:
    name: "{{ pip_apt_package }}"
    state: present
  register: result
  until: result is success
  retries: 5
  delay: 5

- name: Check if setuptools is needed
  set_fact:
    pip_setuptools_package: >-
      {%- if pip_version_to_use|int != ansible_python.version.major|int -%}
        {%- if ansible_python.version.major|int == 3 -%}
          python3-setuptools
        {%- elif ansible_python.version.major|int == 2 -%}
          python-setuptools
        {%- endif -%}
      {%- else -%}
        []
      {%- endif -%}

- name: Install setuptools
  apt:
    name: "{{ pip_setuptools_package }}"
    state: present
  register: result
  until: result is success
  retries: 5
  delay: 5
  when: pip_setuptools_package | length

- name: Install pip package/s
  pip:
    "{{ item }}"
  loop: "{{ pip_install_packages }}"
